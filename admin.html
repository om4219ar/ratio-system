<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>لوحة المدير</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; padding: 20px; }
    .loading { font-style: italic; color: #6c757d; }
    .card { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .profit-item { border-bottom: 1px solid #eee; padding: 10px 0; }
    pre { direction: ltr; text-align: left; }
  </style>
</head>
<body>

<div class="container">
  <h1 class="text-center mb-4">لوحة المدير</h1>

  <!-- حالة التحميل -->
  <div id="loading" class="alert alert-info text-center">جاري التحميل...</div>

  <div id="content" style="display: none;">
    <!-- إضافة عضو -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>إضافة عضو جديد</h5>
        <div class="row g-3">
          <div class="col-md-5">
            <input type="text" id="memberName" class="form-control" placeholder="اسم العضو" required />
          </div>
          <div class="col-md-5">
            <input type="number" id="memberContribution" class="form-control" placeholder="المساهمة المالية" min="0" required />
          </div>
          <div class="col-md-2">
            <button onclick="addMember()" class="btn btn-primary w-100">إضافة</button>
          </div>
        </div>
      </div>
    </div>

    <!-- إدخال الربح -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>إدخال الربح اليومي</h5>
        <div class="row g-3 align-items-center">
          <div class="col-md-5">
            <input type="number" id="dailyProfit" class="form-control" placeholder="الربح اليومي" min="0" required />
          </div>
          <div class="col-md-4">
            <button onclick="addProfit()" class="btn btn-success w-100">تسجيل الربح</button>
          </div>
        </div>
      </div>
    </div>

    <!-- جدول الأعضاء -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>الأعضاء (إجمالي رأس المال: <span id="totalCapital">0</span>)</h5>
        <table class="table table-striped">
          <thead>
            <tr>
              <th>الرقم</th>
              <th>الاسم</th>
              <th>المساهمة</th>
              <th>النسبة (%)</th>
            </tr>
          </thead>
          <tbody id="membersTable"></tbody>
        </table>
      </div>
    </div>

    <!-- سجل الأرباح -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>سجل الأرباح</h5>
        <div id="profitsLog"></div>
      </div>
    </div>

    <!-- نسخ البيانات -->
    <div class="card mb-4">
      <div class="card-body">
        <h5>نسخ البيانات لحفظها في data.json</h5>
        <button onclick="copyData()" class="btn btn-warning mb-2">نسخ البيانات</button>
        <pre id="jsonData" style="max-height: 200px; overflow-y: auto;"></pre>
      </div>
    </div>
  </div>
</div>

<script>
// البيانات
let data = {
  capital: { total: 0, members: [] },
  profits: [],
  lastUpdated: new Date().toISOString()
};

// تحديث إجمالي رأس المال ونسبة الأعضاء
function updateTotals() {
  const total = data.capital.members.reduce((sum, m) => sum + m.contribution, 0);
  data.capital.total = total;

  data.capital.members.forEach(m => {
    m.percentage = total > 0 ? ((m.contribution / total) * 100).toFixed(2) : 0;
  });
}

// تحميل البيانات من localStorage أو تهيئة فارغة
function loadData() {
  const saved = localStorage.getItem('capitalData');
  if (saved) {
    try {
      data = JSON.parse(saved);
      updateTotals(); // إعادة حساب الإجمالي والنسب
    } catch (e) {
      console.error("فشل تحميل البيانات", e);
    }
  } else {
    data = { capital: { total: 0, members: [] }, profits: [], lastUpdated: new Date().toISOString() };
  }
}

// حفظ البيانات في localStorage
function saveData() {
  data.lastUpdated = new Date().toISOString();
  localStorage.setItem('capitalData', JSON.stringify(data));
}

// عرض البيانات
function render() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('content').style.display = 'block';

  // إجمالي رأس المال
  document.getElementById('totalCapital').textContent = data.capital.total.toLocaleString('en-US');

  // جدول الأعضاء
  const membersTable = document.getElementById('membersTable');
  membersTable.innerHTML = '';
  data.capital.members.forEach((m, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i + 1}</td>
      <td>${m.name}</td>
      <td>${m.contribution.toLocaleString('en-US')}</td>
      <td>${m.percentage}%</td>
    `;
    membersTable.appendChild(tr);
  });

  // سجل الأرباح
  const profitsLog = document.getElementById('profitsLog');
  profitsLog.innerHTML = '';
  if (data.profits.length === 0) {
    profitsLog.innerHTML = '<p class="text-muted">لا توجد أرباح مسجلة بعد.</p>';
  } else {
    data.profits.slice().reverse().forEach(p => {
      const item = document.createElement('div');
      item.className = 'profit-item';
      item.innerHTML = `
        <strong>الربح:</strong> ${p.amount.toLocaleString('en-US')} - 
        <strong>التاريخ:</strong> ${new Date(p.date).toLocaleDateString('ar-SA')}
        <div>
          <small>
            50% شركاء: ${(p.distribution.partners).toLocaleString('en-US')} |
            30% إدارة: ${(p.distribution.management).toLocaleString('en-US')} |
            20% مصروفات: ${(p.distribution.expenses).toLocaleString('en-US')}
          </small>
        </div>
      `;
      profitsLog.appendChild(item);
    });
  }

  // نسخ البيانات
  document.getElementById('jsonData').textContent = JSON.stringify(data, null, 2);
}

// إضافة عضو
function addMember() {
  const name = document.getElementById('memberName').value.trim();
  const contribution = parseFloat(document.getElementById('memberContribution').value);

  if (!name || isNaN(contribution) || contribution < 0) {
    alert('يرجى إدخال اسم ومساهمة صحيحة.');
    return;
  }

  data.capital.members.push({
    id: Date.now(), // استخدام timestamp كـ ID فريد
    name,
    contribution
  });

  updateTotals();
  saveData();
  render();
  document.getElementById('memberName').value = '';
  document.getElementById('memberContribution').value = '';
}

// إضافة ربح
function addProfit() {
  const amount = parseFloat(document.getElementById('dailyProfit').value);
  if (isNaN(amount) || amount < 0) {
    alert('يرجى إدخال قيمة ربح صحيحة.');
    return;
  }

  const totalCapital = data.capital.total;
  let partnersShare = 0;
  let managementShare = amount * 0.3;
  let expensesShare = amount * 0.2;

  if (totalCapital > 0) {
    partnersShare = amount * 0.5;
  } else {
    // إذا كان رأس المال صفرًا، لا يمكن توزيع 50% على الشركاء
    // نضيف الفرق إلى الإدارة أو المصروفات؟ نُرجِع 50% إلى الإدارة
    managementShare += amount * 0.5;
    partnersShare = 0;
  }

  data.profits.push({
    date: new Date().toISOString(),
    amount,
    distribution: {
      partners: partnersShare,
      management: managementShare,
      expenses: expensesShare
    }
  });

  saveData();
  render();
}

// نسخ البيانات
function copyData() {
  const text = document.getElementById('jsonData').textContent;
  navigator.clipboard.writeText(text).then(() => {
    alert('تم نسخ البيانات! الصقها في ملف data.json.');
  }).catch(err => {
    alert('فشل النسخ: ' + err);
  });
}

// التحديث التلقائي كل 30 ثانية
function startAutoRefresh() {
  setInterval(() => {
    loadData();
    render();
  }, 30000);
}

// تهيئة الصفحة
window.onload = function () {
  loadData();
  updateTotals();
  render();
  startAutoRefresh();
};
</script>

</body>
</html>